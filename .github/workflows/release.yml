name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.11.6)'
        required: true
        default: 'v1.0.11'

jobs:
  release:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build application
        run: npm run build
        
      - name: Verify build configuration
        shell: bash
        run: |
          echo "🔍 Checking build configuration..."
          echo "Tools directory:"
          ls -la tools/ || echo "❌ Tools directory missing"
          echo "electron-builder.yml buildVersion:"
          grep "buildVersion:" electron-builder.yml || echo "❌ buildVersion not found"
          echo "package.json version:"
          node -p "require('./package.json').version"
        
      - name: Build installer
        run: npm run build && npx electron-builder --win nsis --publish=never
        env:
          CI: false
          GITHUB_ACTIONS: false
          CONTINUOUS_INTEGRATION: false
          NODE_ENV: "production"
          ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES: true
          
      - name: Get versions
        id: versions
        shell: bash
        run: |
          # Get the buildVersion from electron-builder.yml
          BUILD_VERSION=$(grep "buildVersion:" electron-builder.yml | sed 's/.*"\(.*\)".*/\1/')
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG_VERSION="${{ github.event.inputs.version }}"
          else
            TAG_VERSION="${GITHUB_REF#refs/tags/}"
          fi
          
          echo "build_version=$BUILD_VERSION" >> $GITHUB_OUTPUT
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          echo "tag_version=$TAG_VERSION" >> $GITHUB_OUTPUT
          
          echo "Build Version: $BUILD_VERSION"
          echo "Package Version: $PACKAGE_VERSION"
          echo "Tag Version: $TAG_VERSION"
          
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.versions.outputs.tag_version }}
          name: ClipPAilot ${{ steps.versions.outputs.tag_version }}
          body: |
            ## ClipPAilot ${{ steps.versions.outputs.tag_version }} (Build ${{ steps.versions.outputs.build_version }})
            
            ### 🎉 What's New
            - Streamlined installer with single-popup upgrade experience
            - Fixed installer filename to include full build version
            - Improved header RTL/LTR handling for multilingual support
            - Enhanced Chrome-style versioning system
            - Professional installer with logo and clean finish screen
            
            ### 📥 Installation
            1. Download `ClipPAilot-Setup-${{ steps.versions.outputs.build_version }}.exe` below
            2. Run the installer - upgrades are seamless with a single confirmation
            3. Get your free YouTube API key from [Google Cloud Console](https://console.cloud.google.com/)
            4. Enable "YouTube Data API v3" and create an API key
            5. Paste your API key in ClipPAilot settings
            
            ### 🌍 Supported Languages
            - English
            - עברית (Hebrew) - with proper RTL support
            - Español (Spanish)
            - Français (French)
            - Deutsch (German)
            - Português Brasil (Portuguese Brazil)
            - Português Portugal (Portuguese Portugal)
            - 日本語 (Japanese)
            - 中文简体 (Chinese Simplified)
            
            ### 🎯 Features
            - YouTube video search and download
            - Multiple format support (MP3, MP4, AAC, FLAC)
            - Quality selection (720p, 1080p, best)
            - Direct URL downloads
            - Real-time progress tracking
            - Video previews
            - Comprehensive logging for support
            - Clean, intuitive interface
            - Professional installer with upgrade detection
            
            ### 🔧 System Requirements
            - Windows 10 or later
            - Internet connection
            - YouTube API key (free from Google)
            
            ### 📊 Version Information
            - **Application Version**: ${{ steps.versions.outputs.build_version }}
            - **Package Version**: ${{ steps.versions.outputs.package_version }}
            - **Release Tag**: ${{ steps.versions.outputs.tag_version }}
            
            ---
            **Full Changelog**: https://github.com/${{ github.repository }}/commits/${{ steps.versions.outputs.tag_version }}
          files: |
            ./release/ClipPAilot-Setup-${{ steps.versions.outputs.build_version }}.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
